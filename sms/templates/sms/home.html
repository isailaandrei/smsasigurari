{% extends "sms/base.html" %}

{% block page_content %}


<div>

    <div>
    <table class="table table-striped table-bordered">
        <h2> Expirari </h2>
        <tr>
            <th class="active">
                <input type="checkbox" class="select-all checkbox" name="select-all" />
            </th>
            <th class="success">Nume</th>
            <th class="warning">Tip polita</th>
            <th class="info">Numar masina</th>
            <th class="info">Numar de telefon</th>
            <th class="info">Data expirare</th>

        </tr>

        {% if expirari %}
            {% for expirare in expirari %}
            <tr>    
                <td class="active">
                <input type="checkbox" class="select-item checkbox" name="select-item" value="{{ expirare.id }}" />
                </td>
                

                <td class="success">{{ expirare.name }}</td>
                <td class="warning">{{ expirare.tip_asigurare}}</td>
                <td class="info">{{ expirare.numar_masina }}</td>
                <td class="info">{{ expirare.numar_telefon }}</td>
                <td class="info">{{ expirare.valabilitate_sfarsit }}</td>

            </tr>
            {% endfor %}
            
        {% endif %}
    </table>

    <div>
        <button id="select-all" class="btn button-default">(De) Selecteaza Tot</button>
        <button id="delete" type="button" class="btn btn-danger">Sterge</button>
        <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#exampleModal"> Trimite </button>

    </div>

</div>

<br/><br/><br/><br/>


<div>

    <table class="table table-striped table-bordered">
        <h3> SMSuri trimise </h3>
        <tr>
            <th class="success">Nume</th>
            <th class="warning">Tip polita</th>
            <th class="info">Numar de telefon</th>
            <th class="info">Data expirare</th>
            <th class="info">SMSuri trimise</th>

        </tr>

        {% if trimise %}
            {% for sms_trimis in trimise %}
            <tr>        
                <td class="success">{{ sms_trimis.name }}</td>
                <td class="warning">{{ sms_trimis.tip_asigurare}}</td>
                <td class="info">{{ sms_trimis.numar_telefon }}</td>
                <td class="info">{{ sms_trimis.valabilitate_sfarsit }}</td>
                <td class="info">{{ sms_trimis.mesaje_trimise }}</td>

            </tr>
            {% endfor %}
            
        {% endif %}


    </table>

</div>

<!-- Modal -->

<div class="modal fade" id="exampleModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="exampleModalLabel">Trimite SMSuri</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <form>
          <div class="form-group">
            <label for="message-textarea" class="col-form-label">Text</label>
            <textarea rows="10" class="form-control" id="message-textarea" readonly></textarea>
          </div>
        
          <div class="form-group">
            <select id="inputState" class="form-control">
              <option title = "" selected>Alege</option>
                {% if mesaje %}
                  {% for mesaj in mesaje %}

                  <option value='{{mesaj.id}}'title='{{mesaj.message}}'> {{ mesaj }}</option>

                  {% endfor %}  
                {% endif %}

            </select>
          </div>
        </form>
      </div>
      <div class="modal-footer justify-content-between">
        <button type="button" class="float-left btn btn-secondary " data-dismiss="modal">Inchide</button>
        <button id="selected" type="button" class="btn btn-primary">Trimite</button>
      </div>
    </div>
  </div>
</div>

<script>
    $(function(){

        //button send SMS
        $("#selected").click(function () {
            var items=[];
            $("input.select-item:checked:checked").each(function (index,item) {
                items[index] = item.value;
            });
            if (items.length < 1) {
                alert("Nu ati selectat niciun destinatar");
            }else {
                var msgId = $('#inputState').children(":selected").attr("value")
                $.ajax({
                    type: "POST",
                    url: '/sendSMS/',
                    data: {
                      'expirari-ids': JSON.stringify(items),
                      'msg-id': msgId, 
                    },
                    dataType: 'json',
                    success: function (data) {
                        location.reload();
                        // alert("Success! SMSurile au fost trimise");
                    }
                  });
            }
        });

        //button delete 
        $("#delete").click(function () {
            var items=[];
            $("input.select-item:checked:checked").each(function (index,item) {
                items[index] = item.value;
            });
            if (items.length < 1) {
                alert("Nu ati selectat nimic");
            }else {
                $.ajax({
                    type: "POST",
                    url: '/sendSMS/',
                    data: {
                      'Delete': 'True',
                      'expirari-ids': JSON.stringify(items)
                    },
                    dataType: 'json',
                    success: function (data) {
                        location.reload();
                        // alert("Success! SMSurile au fost trimise");
                    }
                  });
            }
        });

        //button select all or cancel
        $("#select-all").click(function () {
            var all = $("input.select-all")[0];
            all.checked = !all.checked
            var checked = all.checked;
            $("input.select-item").each(function (index,item) {
                item.checked = checked;
            });
        });


        //column checkbox select all or cancel
        $("input.select-all").click(function () {
            var checked = this.checked;
            $("input.select-item").each(function (index,item) {
                item.checked = checked;
            });
        });


         $("#inputState").change(function () {
            var id = $('#inputState').children(":selected").attr("title")
            $("#message-textarea")[0].value = id;
    });


});
</script>

{% endblock %}